<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuevo Producto | Sistema de Productos</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #012622;
            --secondary-color: #006359;
            --accent-color: #01433c;
            --light-color: #ece5f0;
            --dark-color: #59114D;
        }

        body {
            background-color: #ece5f0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
            padding: 1rem;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-success {
            background-color: #10b981;
            border-color: #10b981;
        }

        .btn-success:hover {
            background-color: #059669;
            border-color: #059669;
        }

        .btn-secondary {
            background-color: #6b7280;
            border-color: #6b7280;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            border-color: #4b5563;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
        }

        .page-container {
            padding: 2rem 0;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
        }

        .input-group-text {
            background-color: #e5e7eb;
            border-color: #d1d5db;
            color: #4b5563;
        }

        .form-text {
            color: #6b7280;
        }

        .required-field::after {
            content: "*";
            color: #ef4444;
            margin-left: 4px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/productos">
            <i class="bi bi-box-seam-fill me-2"></i>Sistema de Productos
        </a>
    </div>
</nav>

<div class="container page-container">
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/productos" class="text-decoration-none">Inicio</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Nuevo Producto
                    </li>
                </ol>
            </nav>

            <div class="card">
                <div
                    class="card-header d-flex justify-content-between align-items-center"
                >
                    <span><i class="bi bi-plus-circle-fill me-2"></i>Registrar Nuevo Producto</span>
                </div>
                <div class="card-body p-4">
                    <form id="nuevoProductoForm" onsubmit="submitForm(event)">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="nom_pro" class="form-label required-field">Nombre</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="nom_pro"
                                        name="nom_pro"
                                        placeholder="Ingrese nombre del producto"
                                        required
                                    />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="pre_pro" class="form-label required-field">Precio (S/)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                    <input
                                        type="number"
                                        class="form-control"
                                        id="pre_pro"
                                        name="pre_pro"
                                        placeholder="Ej: 19.99"
                                        step="0.01"
                                        min="0"
                                        required
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="id_marca" class="form-label required-field">Marca</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-bookmark-check"></i></span>
                                    <select
                                        class="form-select"
                                        id="id_marca"
                                        name="id_marca"
                                        required
                                    >
                                        <option value="" selected disabled>Seleccione una marca</option>
                                        <% if (marcas && marcas.length > 0) { %>
                                            <% marcas.forEach(function(marca) { %>
                                                <option value="<%= marca.id_marca %>">
                                                    <%= marca.nom_marca %>
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_cat" class="form-label required-field">Categoría</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-list-nested"></i></span>
                                    <select
                                        class="form-select"
                                        id="id_cat"
                                        name="id_cat"
                                        required
                                    >
                                        <option value="" selected disabled>Seleccione una categoría</option>
                                        <% if (categorias && categorias.length > 0) { %>
                                            <% categorias.forEach(function(categoria) { %>
                                                <option value="<%= categoria.id_cat %>">
                                                    <%= categoria.nom_cat %>
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- STOCK + UNIDAD -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="stk_pro" class="form-label required-field">Stock</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-boxes"></i></span>
                                    <input
                                        type="number"
                                        class="form-control"
                                        id="stk_pro"
                                        name="stk_pro"
                                        placeholder="Ingrese stock"
                                        min="0"
                                        required
                                    />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_uni" class="form-label required-field">Unidad de Medida</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-rulers"></i></span>
                                    <select
                                        class="form-select"
                                        id="id_uni"
                                        name="id_uni"
                                        required
                                    >
                                        <option value="" selected disabled>Seleccione una unidad</option>
                                        <% if (unidades && unidades.length > 0) { %>
                                            <% unidades.forEach(function(unidad) { %>
                                                <option value="<%= unidad.id_uni %>">
                                                    <%= unidad.nom_uni %>
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="des_pro" class="form-label">Descripción (Opcional)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                                <textarea
                                    class="form-control"
                                    id="des_pro"
                                    name="des_pro"
                                    rows="3"
                                    placeholder="Descripción detallada del producto..."
                                ></textarea>
                            </div>
                        </div>

                        <div class="mb-4 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="estado" name="estado" checked>
                            <label class="form-check-label" for="estado">Estado (Activo/Inactivo)</label>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Todos los campos marcados con <strong>*</strong> son obligatorios.
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="/productos" class="btn btn-secondary me-2">
                                <i class="bi bi-x-circle me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="bg-dark text-white text-center py-3 mt-5">
    <p class="mb-0">
        Sistema de Gestión de Productos &copy; <%= new Date().getFullYear() %>
    </p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    async function submitForm(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        // Convert checkbox value to a string for the backend
        formData.set('estado', form.estado.checked ? 'A' : 'I'); 
        
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando...';

        try {
            const response = await fetch("/productos/nuevo", {
                method: "POST",
                headers: {
                    Accept: "application/json",
                },
                body: new URLSearchParams(formData),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error HTTP: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                await Swal.fire({
                    title: "¡Éxito!",
                    text: result.message,
                    icon: "success",
                    confirmButtonColor: "#2563eb",
                });
                window.location.href = "/productos";
            } else {
                throw new Error(result.message || "Error al crear producto");
            }
        } catch (error) {
            Swal.fire({
                title: "Error",
                text: error.message,
                icon: "error",
                confirmButtonColor: "#2563eb",
            });

            // Restore button
            submitBtn.disabled = false;
            submitBtn.innerHTML =
                '<i class="bi bi-check-circle me-1"></i>Guardar Producto';
        }
    }
</script>
</body>
</html>